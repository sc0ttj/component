{"version":3,"file":"onLoop.min.js","sources":["../src/onLoop.js"],"sourcesContent":["// adapted from https://github.com/robertcorponoi/deltaframe-extra\n\n;(\"use strict\")\n\n\nclass RAF {\n  id = 0;\n  running = false;\n  fn = () => {};\n  usingSetTimeout = false;\n\n  constructor() {\n    const self = this;\n    window.requestAnimationFrame = window.requestAnimationFrame || window.webkitRequestAnimationFrame || function (f) { return setTimeout(f, 1000 / 60) };\n    window.cancelAnimationFrame = window.cancelAnimationFrame || window.webkitCancelAnimationFrame || function () { clearTimeout(self.id) }\n  }\n\n  start(fn, forceSetTimeout) {\n    if (this.running) return;\n    this.running = true;\n    this.fn = fn;\n    if (forceSetTimeout) {\n      this.usingSetTimeout = true;\n      this.updateTimeout();\n    }\n    else {\n      window.requestAnimationFrame((time) => this.updateRAF(time));\n    }\n  }\n\n  updateRAF(timestamp) {\n    this.running = true;\n    this.fn(timestamp);\n    this.id = window.requestAnimationFrame((time) => this.updateRAF(time));\n  }\n\n  updateTimeout() {\n    let timestamp = window.performance.now();\n    this.fn(timestamp);\n    this.id = window.setTimeout(() => this.updateTimeout(), 1000 / 60);\n  }\n\n  restart() {\n    if (this.usingSetTimeout) {\n      window.clearTimeout(this.id);\n    }\n    else {\n      window.cancelAnimationFrame(this.id);\n    }\n    this.id = 0;\n    this.running = false;\n    if (this.usingSetTimeout) {\n      this.updateTimeout();\n    }\n    else {\n      window.requestAnimationFrame((time) => this.updateRAF(time));\n    }\n    this.running = true;\n  }\n\n  stop() {\n    if (this.usingSetTimeout) {\n      window.clearTimeout(this.id);\n    }\n    else {\n      window.cancelAnimationFrame(this.id);\n    }\n    this.id = 0;\n    this.running = false;\n    this.fn = () => {};\n    return;\n  }\n}\n\nclass Options {\n  minFps = 15;\n  targetFps = 60;\n  maxRestarts = Infinity;\n  runTime = Infinity;\n  forceSetTimeout = false;\n  autoResume = true;\n\n  constructor(options = {}) {\n    Object.assign(this, options);\n  }\n\n  get minFpsCalc() {\n    return Math.floor(1000 / this.minFps);\n  }\n\n  get targetFpsCalc() {\n    return Math.floor(1000 / this.targetFps);\n  }\n}\n\nexport default class onLoop {\n  _options;\n  _restartAttempts;\n  _running;\n  _paused;\n  _fn;\n  _c;\n  _raf;\n  _frame;\n  _time;\n  _prevTime;\n  _delta;\n  _deltaAverage;\n  _deltaHistory;\n  _deltaIndex;\n  _hidden;\n\n  constructor(options, fn, c) {\n    this._options = new Options(options);\n    this._restartAttempts = 0;\n    this._running = false;\n    this._paused = false;\n    this._fn = fn;\n    this._c = c;\n    this._frame = 0;\n    this._time = 0;\n    this._prevTime = 0;\n    this._delta = 0;\n    this._deltaAverage = 0;\n    this._deltaHistory = [];\n    this._deltaIndex = 0;\n    this._raf = new RAF();\n    this._hidden = document.hidden;\n    this._boot();\n  }\n\n  get timesRestarted() { return this._restartAttempts; }\n\n  get isRunning() { return this._running; }\n\n  get isPaused() { return this._paused; }\n\n  get frame() { return this._frame; }\n\n  get time() { return this._time; }\n\n  start() {\n    this._prevTime = 0;\n    this._running = true;\n    this._raf.start((timestamp) => this._update(timestamp), this._options.forceSetTimeout);\n  }\n\n  pause() {\n    this._paused = true;\n    this._running = false;\n  }\n\n  resume() {\n    this._paused = false;\n    this._prevTime = window.performance.now();\n    this._running = true;\n  }\n\n  stop() {\n    this._restartAttempts = 0;\n    this._running = false;\n    this._paused = false;\n    this._fn = () => {};\n    this._frame = 0;\n    this._time = 0;\n    this._prevTime = 0;\n    this._delta = 0;\n    this._deltaHistory = [];\n    this._deltaIndex = 0;\n    document.removeEventListener('visibilitychange', () => this._visibilityChange);\n    this._raf.stop();\n    return;\n  }\n\n  _boot() {\n    document.addEventListener(\"visibilitychange\", () => this._visibilityChange());\n  }\n\n  _update(timestamp) {\n    if (this._paused) return;\n\n    if (timestamp >= this._options.runTime) {\n      this.stop();\n      return;\n    }\n\n    this._time = timestamp;\n\n    this._delta = timestamp - this._prevTime;\n\n    if (this._deltaIndex === 10) this._deltaIndex = 0;\n\n    this._deltaHistory[this._deltaIndex] = this._delta;\n\n    this._deltaIndex++;\n\n    let mean = 0;\n\n    for (let i = 0; i < this._deltaHistory.length; ++i) mean += this._deltaHistory[i];\n\n    mean /= 10;\n\n    this._deltaAverage = mean;\n\n    if (this._deltaAverage >= this._options.minFpsCalc) {\n      if (this._restartAttempts === this._options.maxRestarts) {\n        this.stop();\n\n        return;\n      }\n\n      this._raf.restart();\n\n      this._restartAttempts++;\n    }\n\n    if (this._deltaAverage >= this._options.targetFpsCalc) {\n      this._frame++;\n\n      this._fn(this._c.state, this._delta, this._deltaAverage, timestamp);\n\n      this._prevTime = timestamp;\n    }\n  }\n\n  _visibilityChange() {\n    const visibility = document.visibilityState;\n    if (this.isPaused && this._options.autoResume && visibility === 'visible') this.resume();\n    else if (this.isRunning && visibility === 'hidden') this.pause();\n  }\n}\n"],"names":["RAF","[object Object]","self","this","window","requestAnimationFrame","webkitRequestAnimationFrame","f","setTimeout","cancelAnimationFrame","webkitCancelAnimationFrame","clearTimeout","id","fn","forceSetTimeout","running","usingSetTimeout","updateTimeout","time","updateRAF","timestamp","performance","now","Options","Infinity","options","Object","assign","minFpsCalc","Math","floor","minFps","targetFpsCalc","targetFps","c","_options","_restartAttempts","_running","_paused","_fn","_c","_frame","_time","_prevTime","_delta","_deltaAverage","_deltaHistory","_deltaIndex","_raf","_hidden","document","hidden","_boot","timesRestarted","isRunning","isPaused","frame","start","_update","removeEventListener","_visibilityChange","stop","addEventListener","runTime","mean","i","length","maxRestarts","restart","state","visibility","visibilityState","autoResume","resume","pause"],"mappings":"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"}